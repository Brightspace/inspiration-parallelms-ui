<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="d2l-auth-link">
	<template>
		<style>
			:host {
				display: block;
			}
		</style>
		<a id="link" href="{{href}}" download="{{_getFilename(download, href)}}"><slot></slot></a>
	</template>

	<script>
		(function() {
			var fileServiceWorker;
			class AuthLink extends Polymer.Element {

				static get is() { return 'd2l-auth-link'; }

				static get properties() {
					return {
						supported: Boolean,
						href: String,
						token: String,
						download: String
					};
				}

				constructor() {
					super();
					this.supported = 'serviceWorker' in navigator;
					this._boundHandleClick = this.handleClick.bind(this);
				}

				connectedCallback() {
					super.connectedCallback();
					this.addEventListener('click', this._boundHandleClick);
				}

				disconnectedCallback() {
					super.disconnectedCallback();
					this.removeEventListener('click', this._boundHandleClick);
				}

				_initWorker() {
					if (!fileServiceWorker) {
						fileServiceWorker = navigator.serviceWorker.register(this.resolveUrl('link-sw.js'));
					}
					return fileServiceWorker.then(function(swReg) {
						var swRegTmp = swReg.installing || swReg.waiting;

						return new Promise(function(resolve) {
							if (swReg.active) {
								resolve(swReg);
							}
							swRegTmp.onstatechange = function() {
								if (swRegTmp.state === 'activated') {
									resolve(swReg);
								}
							};
						});
					});
				}

				_sendMessage(message) {
					return new Promise(function(resolve, reject) {
						var messageChannel = new MessageChannel();
						messageChannel.port1.onmessage = function(event) {
							if (event.data.error) {
								reject(event.data.error);
							} else {
								resolve(event.data);
							}
						};
						this._initWorker().then(function(swReg) {
							swReg.active.postMessage(message,
								[messageChannel.port2]);
						});
					}.bind(this));
				}

				handleClick(e) {
					// Stop the navigation, setup the SW, and navigate to the intercepted link
					e.preventDefault();
					var self = this;
					this._sendMessage({
						url: this.href,
						filename: this.filename,
						headers: {
							'Authorization': `Bearer ${this.token}`
						}
					})
						.then(function(message) {
							// Use an iframe to prevent navigation if file fails to download
							self.iframe.src = message.href;
						});
				}

				get iframe() {
					if (!this._iframe) {
						this._iframe = document.createElement('iframe');
						this._iframe.hidden = true;
						document.body.appendChild(this._iframe);
					}
					return this._iframe;
				}

				get filename() {
					if (this.download) {
						return this.download;
					}
					if (this.href) {
						return this.href
							.substring(this.href.lastIndexOf('/') + 1)
							.substring(this.href.lastIndexOf('\\'));
					}
					return 'download';
				}

				_getFilename() {
					return this.filename;
				}
			}

			window.customElements.define(AuthLink.is, AuthLink);
		}());
	</script>
</dom-module>
