<script>
	(function() {
		var fileServiceWorker;
		/*
			@polymerMixin
		*/
		AuthDownloadMixin = function(superClass) {
			return class extends superClass {
				static get properties() {
					return {
						supported: Boolean,
						swSupported: Boolean
					};
				}

				constructor() {
					super();
					this.swSupported = 'serviceWorker' in navigator;
				}

				disconnectedCallback() {
					this._iframe && document.body.removeChild(this._iframe);
				}

				_initWorker() {
					if (!fileServiceWorker) {
						fileServiceWorker = navigator.serviceWorker.register(this.resolveUrl('link-sw.js'));
					}
					return fileServiceWorker.then(function(swReg) {
						var swRegTmp = swReg.installing || swReg.waiting;

						return new Promise(function(resolve) {
							if (swReg.active) {
								resolve(swReg);
							}
							swRegTmp.onstatechange = function() {
								if (swRegTmp.state === 'activated') {
									resolve(swReg);
								}
							};
						});
					});
				}

				_sendMessage(message) {
					return new Promise(function(resolve, reject) {
						var messageChannel = new MessageChannel();
						messageChannel.port1.onmessage = function(event) {
							if (event.data.error) {
								reject(event.data.error);
							} else {
								resolve(event.data);
							}
						};
						this._initWorker().then(function(swReg) {
							swReg.active.postMessage(message,
								[messageChannel.port2]);
						});
					}.bind(this));
				}

				authDownloadFile(href, token, filename) {
					var self = this;
					this._sendMessage({
						url: href,
						filename: filename,
						headers: {
							'Authorization': `Bearer ${token}`
						}
					})
						.then(function(message) {
							// Use an iframe to prevent navigation if file fails to download
							self.iframe.src = message.href;
						});
				}

				get iframe() {
					if (!this._iframe) {
						this._iframe = document.createElement('iframe');
						this._iframe.hidden = true;
						document.body.appendChild(this._iframe);
					}
					return this._iframe;
				}
			};
		};
	}());
</script>
