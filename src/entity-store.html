<link rel="import" href="siren-parser.html">
<script>
(function() {
	'use strict';

	/*
		This store is hacked together to develop entity-mixin.
	*/
	const EntityStore = {

		_store: new Map(),

		_listeners: new Map(),

		addListener: function(entityId, token, listener) {

			if (!entityId || typeof token !== 'string' || typeof listener !== 'function') {
				return;
			}

			if (!this._listeners.has(token)) {
				this._listeners.set(token, new Map());
			}
			var listeners = this._listeners.get(token);
			if (!listeners.has(entityId)) {
				listeners.set(entityId, new Set());
			}
			listeners.get(entityId).add(listener);
		},

		fetch: function(entityId, token) {
			if (!this._store.has(token)) {
				this._store.set(token, new Map());
			}
			const entity = this._store.get(token).get(entityId);
			if (!entity) {
				// uh oh... we don't have it... quick, distract them
				// (todo: fetch the data, then update store and notify once we get the data)
				this._store.get(token).set(entityId, { 'status': 'fetching', 'entity': null });

				var headers = new Headers();
				headers.set('Authorization', `Bearer ${token}`);
				fetch(entityId, {
					method: 'GET',
					headers: headers
				})
					.then(function(res) {
						this.update(entityId, token, res.json());
					}.bind(this));
			}
			return this._store.get(token).get(entityId);
		},

		update: function(entityId, token, entity) {
			if (!this._store.has(token)) {
				this._store.set(token, new Map());
			}
			return new Promise((resolve) => {

				this._store.get(token).set(entityId, { 'status': '', 'entity': entity });
				this._notify(entityId, token, entity);

				resolve(entity);

			});
		},

		removeListener: function(entityId, token, listener) {

			if (!entityId || typeof token !== 'string' || typeof listener !== 'function' || !this._listeners) {
				return;
			}

			if (!this._listeners.has(token)) {
				this._listeners.set(token, new Map());
			}
			var listeners = this._listeners.get(token);
			if (!listeners.has(entityId)) {
				listeners.set(entityId, new Set());
			}
			listeners.get(entityId).delete(listeners);

		},

		_notify: function(entityId, token, entity) {
			if (!this._listeners.has(token)) {
				this._listeners.set(token, new Map());
			}
			var listeners = this._listeners.get(token);
			if (!listeners.has(entityId)) {
				listeners.set(entityId, new Set());
			}

			const listenerSet = listeners.get(entityId);
			if (listeners) {
				for (const listener of listenerSet) {
					listener(entity);
				}
			}
		}

	};

	window.D2L = window.D2L || {};
	window.D2L.EntityStore = EntityStore;

})();
</script>
<script type="text/javascript" src="../data/items.js"></script>
