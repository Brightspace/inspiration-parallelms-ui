<link rel="import" href="siren-parser.html">
<script>
(function() {
	'use strict';

	var connection = new WebSocket("ws://localhost:8080", "protocolOne");
	var clientId = guid();
	var listeners = {};

	connection.onopen = function () {
		connection.send(JSON.stringify({"action": "register", "deviceId": clientId})); // Send the message 'Ping' to the server
	};

	// Log errors
	connection.onerror = function (error) {
		console.log('WebSocket Error ' + error);
	};

	// Log messages from the server
	connection.onmessage = function (e) {
		console.log(e.data);
		var data = JSON.parse(e.data);
		if(data.action && data.action == "invalidate") {
			var resource = data.resource;
			if (listeners[resource]) {
				for(var i=0; i<listeners[resource].length; i++) {
					var token = listeners[resource][i];
					var headers = new Headers();
					headers.set('Authorization', `Bearer ${token}`);
					headers.set("pragma", "no-cache");
					headers.set("cache-control", "no-cache");
					
					fetch(resource, {
						method: 'GET',
						headers: headers
					})
					.then(function(res) {
						return res.json();
					})
					.then(function(json) {
						this.update(resource, token, json);
					}.bind(EntityStore));
				}
			}
		}
		
	};

	function listenForChanges(resource, token)  {
		if(listeners[resource]) {
			if(listeners[resource].includes(token)) {
				listeners[resource].push(token);
			}
		} else {
			listeners[resource] = [token];
		}

		connection.send(JSON.stringify({"action": "subscribe", "resource": resource}));
	}
		
	// from https://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript
	function guid() {
		function s4() {
			return Math.floor((1 + Math.random()) * 0x10000)
			.toString(16)
			.substring(1);
		}
		return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
			s4() + '-' + s4() + s4() + s4();
	}

	/*
		This store is hacked together to develop entity-mixin.
	*/
	const EntityStore = {

		_store: new Map(),

		_listeners: new Map(),

		

		_initContainer(map, entityId, token, init) {
			if (!map.has(token)) {
				map.set(token, new Map());
			}
			var entityMap = map.get(token);
			if (init && !entityMap.has(entityId)) {
				entityMap.set(entityId, init);
			}
			return entityMap.get(entityId);
		},

		addListener: function(entityId, token, listener) {

			if (!entityId || typeof token !== 'string' || typeof listener !== 'function') {
				return;
			}

			this._initContainer(this._listeners, entityId, token, new Set()).add(listener);

		},

		fetch: function(entityId, token) {
			var entity = this._initContainer(this._store, entityId, token);
			if (!entity) {
				this._store.get(token).set(entityId, { 'status': 'fetching', 'entity': null });

				var headers = new Headers();
				headers.set('Authorization', `Bearer ${token}`);
				fetch(entityId, {
					method: 'GET',
					headers: headers
				})
					.then(function(res) {
						return res.json();
					})
					.then(function(json) {
						this.update(entityId, token, json);
					}.bind(this));
			}

			listenForChanges(entityId, token);
			return this._store.get(token).get(entityId);
		},

		update: function(entityId, token, entity) {
			this._initContainer(this._store, entityId, token);
			return new Promise((resolve) => {

				this._store.get(token).set(entityId, { 'status': '', 'entity': entity });
				this._notify(entityId, token, entity);

				resolve(entity);

			});
		},

		removeListener: function(entityId, token, listener) {

			if (!entityId || typeof token !== 'string' || typeof listener !== 'function' || !this._listeners) {
				return;
			}

			this._initContainer(this._listeners, entityId, token, new Set()).delete(listener);

		},

		_notify: function(entityId, token, entity) {
			const listenerSet = this._initContainer(this._listeners, entityId, token, new Set());
			for (const listener of listenerSet) {
				listener(entity);
			}
		}

	};

	window.D2L = window.D2L || {};
	window.D2L.EntityStore = EntityStore;

})();
</script>
<script type="text/javascript" src="../data/items.js"></script>
