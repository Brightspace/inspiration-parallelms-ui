<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="siren-entity.html">
<link rel="import" href="shared-styles.html">

<link rel="lazy-import" href="courses/courses-drawer.html">

<dom-module id="my-login-page">
	<template>
		<style include="shared-styles">
			:host {
				display: block;
				overflow: hidden;
			}
			.header {
				text-align: center;
				font-weight: lighter;
			}
			.login-container {
				width: 300px;
				height: auto;
				margin-left: auto;
				margin-right: auto;
			}
			.endpoints-dropdown {
				width: 100%;
			}
			.login-button {
				background-color: cornflowerblue; color: white; height: 100%; width: 100%; margin: 0;
			}
		</style>
		<template is="dom-if" if="{{wannaLogIn}}">
			<d2l-siren-entity href="{{entrypoint}}" token="{{token}}" entity="{{rootEntity}}"></d2l-siren-entity>
		</template>
		<div class="login-container">
			<h2 class="header" id="headerText">ParalleLMS</h2>
			<paper-dropdown-menu label="Endpoints" class="endpoints-dropdown" id="dropdown">
				<paper-listbox slot="dropdown-content" selected="{{selected}}">
					<template is="dom-repeat" items="{{endpoints}}">
						<paper-item>{{item}}</paper-item>
					</template>
				</paper-listbox>
			</paper-dropdown-menu>
			<paper-input label="Token" value="{{token}}" id="tokenInput"></paper-input>
			<paper-checkbox class="basic-top-bottom-padding" checked="{{enableOffline}}" id="checkbox">Enable offline mode</paper-checkbox>
			<paper-button class="login-button" on-tap="_login" id="loginButton">Log In</paper-button>
		</div>
		<slot></slot>
	</template>

	<script>
		class LoginPage extends Polymer.Element {

			static get is() { return 'my-login-page'; }

			static get properties() {
				return {
					token: {
						type: String,
						notify: true
					},
					href: {
						type: String,
						notify: true
					},
					selected: {
						type: Number,
						value: 0,
						observer: '_endpointChanged'
					},
					endpoints: {
						type: Array,
						value: [
							'https://api.proddev.d2l',
							'https://api.dev.brightspace.com',
							'https://api.brightspace.com'
						]
					},
					entrypoint: {
						type: String,
						value: 'https://api.proddev.d2l'
					},
					rootEntity: {
						type: Object,
						observer: '_rootEntityChanged'
					},
					wannaLogIn: {
						type: Boolean,
						value: false
					},
					route: Object,
					enableOffline: Boolean
				};
			}

			static get observers() {
				return [
					'_startPrefetch(enableOffline, entrypoint, token)'
				];
			}

			_endpointChanged() {
				this.entrypoint = this.endpoints[this.selected];
			}

			_login() {
				if (this.href && this.href !== '') {
					this._performLogin();
				} else if (this.token && this.token !== '') {
					this.wannaLogIn = true;
				} else {
					this.wannaLogIn = false;
				}
			}

			_animateShit() {
				var self = this;
				var delay = 500;
				var animation = 'bounceOutRight'
				setTimeout(function() {
					self.$.headerText.classList.add(animation);
					self.$.headerText.classList.add('animated');

					setTimeout(function() {
						self.$.dropdown.classList.add(animation);
						self.$.dropdown.classList.add('animated');

						setTimeout(function() {
							self.$.tokenInput.classList.add(animation);
							self.$.tokenInput.classList.add('animated');

							setTimeout(function() {
								self.$.loginButton.classList.add(animation);
								self.$.loginButton.classList.add('animated');

								self.$.checkbox.classList.add(animation);
								self.$.checkbox.classList.add('animated');
							}, delay);
						}, delay);
					}, delay);
				}, delay);

				setTimeout(function() {
					self.$.headerText.classList.add('invisible');
					self.$.headerText.classList.remove(animation);
					self.$.headerText.classList.remove('animated');
				}, 3000);
			}

			_rootEntityChanged() {
				var self = this;
				var rootEntityLink = this.rootEntity && this.rootEntity.getLinkByRel('self') && this.rootEntity.getLinkByRel('self').href;
				if (rootEntityLink) this.href = rootEntityLink;
				this._performLogin();
			}

			_performLogin() {
				var self = this;
				if (this.href && this.href !== '') {
					this._animateShit();
					var animation = 'bounceOutRight'
					setTimeout(function() {
						self.set('route.path', 'welcome-page');
						self.$.headerText.classList.remove('invisible');

						self.$.dropdown.classList.remove(animation);
						self.$.dropdown.classList.remove('animated');
						self.$.dropdown.classList.remove('invisible');

						self.$.tokenInput.classList.remove(animation);
						self.$.tokenInput.classList.remove('animated');
						self.$.tokenInput.classList.remove('invisible');

						self.$.loginButton.classList.remove(animation);
						self.$.loginButton.classList.remove('animated');
						self.$.loginButton.classList.remove('invisible');

						self.$.checkbox.classList.remove(animation);
						self.$.checkbox.classList.remove('animated');
						self.$.checkbox.classList.remove('invisible');
					}, 3500);
					self.wannaLogIn = false;
				} else {
					this.wannaLogIn = false;
				}
			}

			_startPrefetch(enableOffline, entrypoint, token) {
				if (enableOffline && entrypoint && token) {
					var resolvedPageUrl = this.resolveUrl('courses/courses-drawer.html');
					Polymer.importHref(
						resolvedPageUrl,
						() => window.customElements.get('d2l-courses-drawer').beginPrefetch(entrypoint, token),
						null,
						true
					);
				}
			}
		}

		window.customElements.define(LoginPage.is, LoginPage);
	</script>
</dom-module>
