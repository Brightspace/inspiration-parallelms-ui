<link rel="import" href="entity-store.html">

<script>
	var connection = new WebSocket("ws://localhost:8080", "protocolOne");
		var clientId = guid();
		var listeners = {};

        connection.onopen = function () {
            connection.send(JSON.stringify({"action": "register", "deviceId": clientId})); // Send the message 'Ping' to the server
        };

        // Log errors
        connection.onerror = function (error) {
            console.log('WebSocket Error ' + error);
        };

        // Log messages from the server
        connection.onmessage = function (e) {
			var data = JSON.parse(e.data);
			if(data.action && data.action == "invalidate") {
				var resource = data.resource;
				if (listeners[resource]) {
					for(var i=0; i<listeners[resource].length; i++) {
						listeners[resource]();
					}
				}
			}
			
		};

		function listenForChanges(resource, token, callback)  {
			if(listeners[resource]) {
				listeners[resource].push(callback);
			} else {
				listeners[resource] = [callback];
			}

			connection.send(JSON.stringify({"action": "subscribe", "resource": resource}));
		}
		
		// from https://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript
        function guid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                s4() + '-' + s4() + s4() + s4();
        }

	/*
		@polymerMixin
	*/
	SirenActionMixin = function(superClass) {
		return class extends superClass {
			static get properties() {
				return {
					token: {
						type: String
					}
				};
			}

			getSirenFields(action) {
				var url = new URL(action.href, window.location.origin);
				var fields;
				if (action.method === 'GET' || action.method === 'HEAD') {
					fields = url.searchParams;
				} else if (action.type === 'application/x-www-form-urlencoded') {
					fields = new URLSearchParams();
				} else {
					fields = new FormData();
				}
				action.fields.forEach(function(field) {
					// if the field is specified multiple times, assume it is intentional
					fields.append(field.name, field.value);
				});
				return fields;
			}

			

			performSirenAction(action, fields) {
				if (!action) {
					return Promise.reject(new Error('No action given'));
				}
				var headers = new Headers();
				this.token && headers.append('Authorization', `Bearer ${this.token}`);

				var url = new URL(action.href, window.location.origin);
				var body;

				fields = fields || this.getSirenFields(action);
				if (action.method === 'GET' || action.method === 'HEAD') {
					url = new URL(url.pathname + '?' + fields.toString(), url.origin);
				} else {
					body = fields;
				}

				if (body && action.type.indexOf('json') !== -1) {
					var json = {};
					for (var key of body.keys()) {
						var values = body.getAll(key);
						if (values.length > 1) {
							json[key] = values;
						} else {
							json[key] = values[0];
						}
					}
					headers.set('Content-Type', action.type);
					body = JSON.stringify(json);
				}

				var token = this.token;
				// such a hacky clone, but is fast based on 
				// https://stackoverflow.com/questions/122102/what-is-the-most-efficient-way-to-deep-clone-an-object-in-javascript
				var noCacheHeaders = JSON.parse(JSON.stringify(headers));
				noCacheHeaders.set("pragma", "no-cache");
				noCacheHeaders.set("cache-control", "no-cache");

				var updateFunction = function() {
					fetch(url.href, {
					method: action.method,
					body: body,
					headers: noCacheHeaders
				})
					.then(function(response) {
						return window.D2L.EntityStore.update(url.href, token, response);
					});
				};

				listenForChanges(url.href, updateFunction);
				return fetch(url.href, {
					method: action.method,
					body: body,
					headers: headers
				})
					.then(function(response) {
						return window.D2L.EntityStore.update(url.href, token, response);
					});
			}
		};
	};
</script>
