<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="course-name.html">
<link rel="import" href="root/root.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="user/user-card-top.html">
<link rel="import" href="search-results-page.html">
<link rel="import" href="search/search-input.html">
<link rel="import" href="courses/courses-drawer.html">

<link rel="lazy-import" href="my-app-main-page.html">
<link rel="lazy-import" href="my-login-page.html">
<link rel="lazy-import" href="my-welcome-page.html">
<link rel="lazy-import" href="my-view1.html">
<link rel="lazy-import" href="my-view2.html">
<link rel="lazy-import" href="my-view3.html">
<link rel="lazy-import" href="my-view404.html">
<link rel="lazy-import" href="my-course-page.html">

<dom-module id="my-app">
	<template>
		<style include="shared-styles">
			:host {
				--app-primary-color: #4285f4;
				--app-secondary-color: black;
				display: block;
				height: 100vh;
			}

			app-header {
				color: #fff;
				background-color: var(--app-primary-color);
			}

			app-header paper-icon-button {
				--paper-icon-button-ink-color: white;
			}

			app-toolbar {
				background-color: #E87511;
			}

			.drawer-contents {
				display: flex;
				flex-direction: column;
				align-items: center;
				height: 100%;
				overflow: auto;
			}

			.title {
				margin-top: 20px;
				margin-bottom: 20px;
				text-align: center;
			}

			a:active {
				color: blue;
			}

			.search-bar {
				width: 100%;
				--paper-input-container-color: white;
				--paper-input-container-focus-color: white;
				--paper-input-container-input-color: white;
				padding-left: 20px;
				padding-right: 20px;
			}
		</style>

		<app-location route="{{route}}" url-space-regex="^[[rootPath]]"></app-location>

		<app-route
			route="{{route}}"
			pattern="[[rootPath]]:page"
			data="{{routeData}}"
			tail="{{subroute}}"></app-route>

		<app-drawer-layout force-narrow>
			<app-drawer opened="{{drawerOpened}}" slot="drawer" id="drawer">
				<div id="drawercontents" class="drawer-contents">
					<a href="./app-main-page" class="title">ParalleLMS</a>
					<a href="view1" class="title">Organization Home</a>
					<d2l-courses-drawer href="{{rootHref}}" token="{{token}}" scroller="[[$.drawercontents]]"></d2l-courses-drawer>
				</div>
			</app-drawer>
			<app-header-layout>
				<app-header slot="header">
					<app-toolbar>
						<paper-icon-button icon="menu" on-click="_toggleDrawer"></paper-icon-button>
						<template is="dom-if" if="{{showSearch}}">
							<d2l-search-input label="Search" class="search-bar" value="{{searchString}}" results="{{searchResults}}"></d2l-search-input>
							<template is="dom-if" if="{{token}}">
								<d2l-user-card-top class="flex-right" style="white-space:nowrap; align-self: center;" token="{{token}}" href="{{rootHref}}"></d2l-user-card-top>
							</template>
						</template>
					</app-toolbar>
				</app-header>

				<div>
					<template is="dom-if" if="{{showSearchResults}}">
						<d2l-search-results-page results="{{searchResults}}"></d2l-search-results-page>
					</template>

					<template is="dom-if" if="{{!showSearchResults}}">
						<iron-pages
							selected="[[page]]"
							attr-for-selected="name"
							fallback-selection="view404"
							role="main">
							<my-app-main-page name="app-main-page" href="{{rootHref}}" token="{{token}}" route="{{route}}"></my-app-main-page>
							<my-view1 name="view1" token="{{token}}" href="{{rootHref}}"></my-view1>
							<my-login-page name="login-page" href="{{rootHref}}" token="{{token}}" route="{{route}}"></my-login-page>
							<my-welcome-page name="welcome-page" href="{{rootHref}}" token="{{token}}" route="{{route}}"></my-welcome-page>
							<my-view2 name="view2"></my-view2>
							<my-view3 name="view3"></my-view3>
							<my-view404 name="view404"></my-view404>
							<my-course-page name="course-page" href="{{rootHref}}" token="{{token}}" route="{{route}}"></my-course-page>
						</iron-pages>
					</template>
				</div>
			</app-header-layout>
		</app-drawer-layout>

	</template>

	<script>
		window.performance && performance.mark && performance.mark('parallelms-app.beforeRegister');

		class MyApp extends Polymer.Element {
			static get is() { return 'my-app'; }

			static get properties() {
				return {
					page: {
						type: String,
						reflectToAttribute: true,
						observer: '_pageChanged'
					},
					routeData: Object,
					subroute: String,
					// This shouldn't be neccessary, but the Analyzer isn't picking up
					// Polymer.Element#rootPath
					rootPath: String,
					searchString: String,
					showSearchResults: {
						type: String,
						value: false
					},
					searchResults: Array,
					rootHref: {
						type: String
					},
					token: {
						type: String
					},
					showSearch: {
						type: Boolean,
						value: false
					},
					drawerOpened: Boolean
				};
			}

			static get observers() {
				return [
					'_routePageChanged(routeData.page)',
					'_searchResultChanged(searchString)'
				];
			}

			constructor() {
				super();
				window.performance && performance.mark && performance.mark('parallelms-app.created');
			}

			_toggleDrawer() {
				this.$.drawer.toggle();
			}

			_routePageChanged(page) {
				// redirect to login page when there is no token
				if (page !== 'login-page' && !this.token) {
					page = 'login-page';
				}

				// If no page was found in the route data, page will be an empty string.
				// Default to 'login-page' in that case.
				this.page = page || 'login-page';
				this.searchString = '';
				this.drawerOpened = false;
				if (page === '' || page === 'welcome-page' || page === 'login-page') {
					this.showSearch = false;
				} else if (this.token !== '') {
					this.showSearch = true;
				}
			}

			_pageChanged(page) {
				// Load page import on demand. Show 404 page if fails
				var resolvedPageUrl = this.resolveUrl('my-' + page + '.html');
				Polymer.importHref(
					resolvedPageUrl,
					null,
					this._showPage404.bind(this),
					true
				);
			}

			_showPage404() {
				this.page = 'view404';
			}

			_searchResultChanged() {
				this.showSearchResults = this.searchString.length > 1;
			}
		}

		window.customElements.define(MyApp.is, MyApp);
	</script>
</dom-module>
